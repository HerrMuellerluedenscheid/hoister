# Multi-agent test setup
#
# Simulates multiple hoister agents on different hosts, all reporting to a
# single controller + frontend.
#
# All agents share the same Docker socket so they see the same containers.
# In production each agent would run on a separate host with its own Docker
# daemon. The controller groups incoming state by hostname + project, so the
# dashboard will show each agent independently.
#
# To also test multiple *projects*, use the helper script:
#   test/run-multi-project.sh
#
# Prerequisites:
#   just gen-certs
#
# Usage:
#   docker compose -f test/docker-compose.multi-agent.yaml up --build

name: multi-agent-test

services:
  # ── Controller ──────────────────────────────────────────────
  hoister-controller:
    image: emrius11/hoister-controller:latest
    build:
      context: ..
      dockerfile: controller/Dockerfile
    volumes:
      - controller-data:/data
      - ../certs:/certs:ro
    labels:
      - "hoister.hide=true"
    environment:
      HOISTER_CONTROLLER_TLS_CERT_PATH: /certs/server.pem
      HOISTER_CONTROLLER_TLS_KEY_PATH: /certs/server-key.pem

  # ── Frontend ────────────────────────────────────────────────
  hoister-frontend:
    image: emrius11/hoister-frontend:latest
    build:
      context: ../frontend
    ports:
      - "3000:3000"
    volumes:
      - ../certs/ca.pem:/certs/ca.pem:ro
    labels:
      - "hoister.hide=true"
    environment:
      HOISTER_CONTROLLER_URL: "https://hoister-controller:3033"
      HOISTER_AUTH_USERNAME: admin
      HOISTER_AUTH_PASSWORD: password
      NODE_EXTRA_CA_CERTS: /certs/ca.pem

  # ── Agent: host-alpha ───────────────────────────────────────
  hoister-alpha:
    image: emrius11/hoister:latest
    build:
      context: ..
      dockerfile: agent/Dockerfile
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ../certs/ca.pem:/certs/ca.pem:ro
    labels:
      - "hoister.hide=true"
    environment:
      HOISTER_HOSTNAME: host-alpha
      HOISTER_PROJECT: multi-agent-test
      HOISTER_CONTROLLER_URL: "https://hoister-controller:3033"
      HOISTER_CONTROLLER_CA_CERT_PATH: /certs/ca.pem
      HOISTER_SCHEDULE_INTERVAL: "30"

  # ── Agent: host-beta ────────────────────────────────────────
  hoister-beta:
    image: emrius11/hoister:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ../certs/ca.pem:/certs/ca.pem:ro
    labels:
      - "hoister.hide=true"
    environment:
      HOISTER_HOSTNAME: host-beta
      HOISTER_PROJECT: multi-agent-test
      HOISTER_CONTROLLER_URL: "https://hoister-controller:3033"
      HOISTER_CONTROLLER_CA_CERT_PATH: /certs/ca.pem
      HOISTER_SCHEDULE_INTERVAL: "30"

  # ── Agent: host-gamma ───────────────────────────────────────
  hoister-gamma:
    image: emrius11/hoister:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ../certs/ca.pem:/certs/ca.pem:ro
    labels:
      - "hoister.hide=true"
    environment:
      HOISTER_HOSTNAME: host-gamma
      HOISTER_PROJECT: multi-agent-test
      HOISTER_CONTROLLER_URL: "https://hoister-controller:3033"
      HOISTER_CONTROLLER_CA_CERT_PATH: /certs/ca.pem
      HOISTER_SCHEDULE_INTERVAL: "30"

  # ── Workload containers (monitored by the agents) ───────────
  nginx:
    image: nginx:latest
    labels:
      - "hoister.enable=true"

  redis:
    image: redis:alpine
    labels:
      - "hoister.enable=true"

  httpbin:
    image: kennethreitz/httpbin:latest
    labels:
      - "hoister.enable=true"

volumes:
  controller-data:
